<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ================================================================
         EXTENSION VUES: OT - Nouveau workflow export
         Ajoute les boutons et √©tats pour le flux export complet
         ================================================================ -->

    <!-- Extension de la vue Tree pour les nouveaux √©tats -->
    <record id="potting_transit_order_view_tree_export" model="ir.ui.view">
        <field name="name">potting.transit.order.tree.export</field>
        <field name="model">potting.transit.order</field>
        <field name="inherit_id" ref="potting_transit_order_view_tree"/>
        <field name="arch" type="xml">
            <!-- Ajouter d√©coration pour les nouveaux √©tats -->
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-info">state in ('draft', 'formule_linked')</attribute>
                <attribute name="decoration-warning">state in ('lots_generated', 'in_progress', 'taxes_paid')</attribute>
                <attribute name="decoration-success">state in ('done', 'dus_paid', 'sold')</attribute>
            </xpath>
            <!-- Ajouter la colonne formule_id -->
            <xpath expr="//field[@name='customer_order_id']" position="after">
                <field name="formule_id" optional="show"/>
            </xpath>
            <!-- Ajouter les colonnes paiement -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="taxes_paid" widget="boolean" optional="show"/>
                <field name="dus_paid" widget="boolean" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Extension de la vue Form pour le workflow export -->
    <record id="potting_transit_order_view_form_export" model="ir.ui.view">
        <field name="name">potting.transit.order.form.export</field>
        <field name="model">potting.transit.order</field>
        <field name="inherit_id" ref="potting_transit_order_view_form"/>
        <field name="arch" type="xml">
            <!-- Mise √† jour du statusbar avec tous les √©tats -->
            <xpath expr="//field[@name='state'][@widget='statusbar']" position="replace">
                <field name="state" widget="statusbar" 
                       statusbar_visible="draft,formule_linked,taxes_paid,sold,dus_paid,done"/>
            </xpath>

            <!-- Ajout des boutons du workflow export -->
            <xpath expr="//button[@name='action_generate_lots']" position="before">
                <!-- Bouton paiement taxes (apr√®s liaison formule) -->
                <button name="action_open_taxes_payment_wizard" 
                        type="object" 
                        string="üí∞ Payer Taxes" 
                        class="btn-warning"
                        invisible="state != 'formule_linked' or taxes_paid"
                        groups="potting_management.group_potting_ot_manager,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
                
                <!-- Bouton marquer vendu (apr√®s taxes pay√©es) -->
                <button name="action_mark_sold" 
                        type="object" 
                        string="üìã Marquer vendu" 
                        class="btn-primary"
                        invisible="state != 'taxes_paid'"
                        groups="potting_management.group_potting_ot_manager,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
                
                <!-- Bouton paiement DUS (apr√®s vente) -->
                <button name="action_open_dus_payment_wizard" 
                        type="object" 
                        string="üí∞ Payer DUS" 
                        class="btn-success"
                        invisible="state != 'sold' or dus_paid"
                        groups="potting_management.group_potting_ot_manager,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
                
                <!-- Bouton finaliser (apr√®s DUS pay√©) -->
                <button name="action_complete" 
                        type="object" 
                        string="‚úÖ Finaliser OT" 
                        class="btn-success"
                        invisible="state != 'dus_paid'"
                        groups="potting_management.group_potting_ot_manager,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
            </xpath>

            <!-- Ajout des champs invisibles pour contr√¥le boutons -->
            <xpath expr="//field[@name='is_invoiced']" position="after">
                <field name="taxes_paid" invisible="1"/>
                <field name="dus_paid" invisible="1"/>
            </xpath>

            <!-- Ajout onglet Allocations Contrats dans le notebook -->
            <xpath expr="//page[@name='lots']" position="before">
                <page string="üìä Allocations Contrats" name="contract_allocations">
                    <div class="alert alert-info" role="alert">
                        <i class="fa fa-info-circle"/> 
                        R√©partissez le tonnage de cet OT sur plusieurs contrats. 
                        Le prix moyen pond√©r√© sera calcul√© automatiquement.
                    </div>
                    <field name="contract_allocation_ids" 
                           readonly="state not in ('draft', 'formule_linked')">
                        <tree string="Allocations" editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="customer_order_id" 
                                   domain="[('state', 'in', ['confirmed', 'in_progress']), ('remaining_contract_tonnage', '>', 0)]"
                                   options="{'no_create': True}"/>
                            <field name="contract_number" readonly="1"/>
                            <field name="contract_tonnage_restant" readonly="1"/>
                            <field name="tonnage_alloue"/>
                            <field name="pourcentage_ot" readonly="1"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="contract_unit_price" readonly="1"/>
                            <field name="montant_alloue" readonly="1" sum="Total"/>
                        </tree>
                    </field>
                    <group class="mt-3">
                        <group>
                            <field name="total_tonnage_alloue" readonly="1" 
                                   string="Total tonnage allou√©"/>
                            <field name="prix_moyen_pondere" readonly="1"
                                   string="Prix moyen pond√©r√©"/>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- Ajout section Paiements Export -->
            <xpath expr="//group[.//field[@name='export_duty_collected']]" position="after">
                <group string="üí≥ Paiements Export" 
                       invisible="state == 'draft'"
                       col="4">
                    <group>
                        <label for="taxes_paid" string="Taxes (1√®re partie)"/>
                        <div class="d-flex align-items-center">
                            <field name="taxes_paid" widget="boolean" readonly="1" class="me-2"/>
                            <field name="taxes_check_number" readonly="1" placeholder="N¬∞ ch√®que"
                                   invisible="not taxes_paid"/>
                        </div>
                        <field name="taxes_payment_date" readonly="1" invisible="not taxes_paid"/>
                    </group>
                    <group>
                        <label for="dus_paid" string="DUS (2√®me partie)"/>
                        <div class="d-flex align-items-center">
                            <field name="dus_paid" widget="boolean" readonly="1" class="me-2"/>
                            <field name="dus_check_number" readonly="1" placeholder="N¬∞ ch√®que"
                                   invisible="not dus_paid"/>
                        </div>
                        <field name="dus_payment_date" readonly="1" invisible="not dus_paid"/>
                    </group>
                </group>
            </xpath>

        </field>
    </record>

    <!-- Extension de la recherche pour les nouveaux √©tats -->
    <record id="potting_transit_order_view_search_export" model="ir.ui.view">
        <field name="name">potting.transit.order.search.export</field>
        <field name="model">potting.transit.order</field>
        <field name="inherit_id" ref="potting_transit_order_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='ready_validation']" position="after">
                <filter string="Formule li√©e" name="formule_linked" domain="[('state', '=', 'formule_linked')]"/>
                <filter string="Taxes pay√©es" name="taxes_paid" domain="[('state', '=', 'taxes_paid')]"/>
                <filter string="Vendu" name="sold" domain="[('state', '=', 'sold')]"/>
                <filter string="DUS pay√©" name="dus_paid" domain="[('state', '=', 'dus_paid')]"/>
                <separator/>
                <filter string="Taxes en attente" name="taxes_pending" 
                        domain="[('state', '=', 'formule_linked'), ('taxes_paid', '=', False)]"/>
                <filter string="DUS en attente" name="dus_pending" 
                        domain="[('state', '=', 'sold'), ('dus_paid', '=', False)]"/>
            </xpath>
            <xpath expr="//filter[@name='state']" position="after">
                <filter string="Formule" name="group_formule" context="{'group_by': 'formule_id'}"/>
            </xpath>
        </field>
    </record>

    <!-- Action sp√©cifique pour gestionnaire OT -->
    <record id="action_potting_transit_order_ot_manager" model="ir.actions.act_window">
        <field name="name">Gestion OT - Export</field>
        <field name="res_model">potting.transit.order</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="context">{
            'search_default_formule_linked': 1,
            'search_default_taxes_pending': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucun OT en attente de traitement
            </p>
            <p>
                Cette vue affiche les OT qui sont li√©s √† une formule et en attente de paiement des taxes.
            </p>
        </field>
    </record>

</odoo>
