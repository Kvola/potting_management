<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ====================================================================
         CONFIRMATION DE VENTE (CV) - VUES
         ==================================================================== -->

    <!-- Tree View -->
    <record id="potting_confirmation_vente_view_tree" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.tree</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <tree string="Confirmations de Vente" 
                  decoration-info="state == 'draft'" 
                  decoration-success="state == 'active'"
                  decoration-warning="state == 'consumed'" 
                  decoration-danger="state == 'expired'"
                  decoration-muted="state == 'cancelled'"
                  multi_edit="1"
                  sample="1"
                  default_order="date_emission desc">
                <header>
                    <button name="action_activate" type="object" string="Activer" class="btn-primary"/>
                </header>
                <field name="company_id" column_invisible="1"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="name" decoration-bf="1" string="N¬∞ CV"/>
                <field name="reference_ccc" optional="show" string="R√©f. CCC"/>
                <field name="campaign_id" string="Campagne"/>
                <field name="product_type" optional="show" widget="badge"
                       decoration-info="product_type == 'cacao'"
                       decoration-success="product_type == 'cafe'"/>
                <field name="date_emission" widget="date" string="√âmission"/>
                <field name="date_end" widget="date" string="Expiration"
                       decoration-danger="date_end &lt; current_date"
                       decoration-warning="date_end &lt;= (current_date + 30)"/>
                <field name="tonnage_autorise" string="Autoris√© (T)" sum="Total" decoration-bf="1"/>
                <field name="tonnage_utilise" string="Utilis√© (T)" sum="Total"
                       decoration-info="tonnage_utilise > 0"/>
                <field name="tonnage_restant" string="Restant (T)" sum="Total" 
                       decoration-danger="tonnage_restant &lt;= 0"
                       decoration-success="tonnage_restant > 0"
                       decoration-bf="1"/>
                <field name="tonnage_progress" widget="progressbar" optional="show" string="Progression"/>
                <field name="prix_tonnage" widget="monetary" string="Prix/T" optional="hide"/>
                <field name="destination_country_id" optional="show" string="Destination"/>
                <field name="customer_order_count" string="Contrats" optional="hide"
                       decoration-info="customer_order_count > 0"/>
                <field name="formule_count" string="Formules" optional="show"
                       decoration-success="formule_count > 0"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'draft'" 
                       decoration-success="state == 'active'"
                       decoration-warning="state == 'consumed'"
                       decoration-danger="state == 'expired'"
                       decoration-muted="state == 'cancelled'"/>
            </tree>
        </field>
    </record>

    <!-- Form View -->
    <record id="potting_confirmation_vente_view_form" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.form</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <form string="Confirmation de Vente">
                <header>
                    <button name="action_activate" type="object" string="‚úÖ Activer" 
                            class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_consume" type="object" string="üì¶ Marquer consomm√©e" 
                            class="btn-warning" invisible="state != 'active'"
                            confirm="√ätes-vous s√ªr de vouloir marquer cette CV comme consomm√©e ?"/>
                    <button name="action_expire" type="object" string="‚è∞ Marquer expir√©e" 
                            invisible="state not in ('active', 'consumed')"/>
                    <button name="action_cancel" type="object" string="‚ùå Annuler" 
                            invisible="state in ('cancelled', 'expired')"/>
                    <button name="action_draft" type="object" string="‚Ü©Ô∏è Remettre en brouillon" 
                            invisible="state != 'cancelled'"
                            groups="potting_management.group_potting_manager"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,active,consumed,expired"/>
                </header>
                <sheet>
                    <!-- Alertes visuelles -->
                    <div class="alert alert-warning mb-3" role="alert" 
                         invisible="days_remaining > 7 or state != 'active'">
                        <i class="fa fa-exclamation-triangle"/> 
                        <strong>Attention !</strong> Cette CV expire dans 
                        <field name="days_remaining" class="fw-bold"/> jour(s).
                        <button name="action_extend_validity" type="object" 
                                class="btn btn-sm btn-warning ms-2" string="Prolonger d'un mois"/>
                    </div>
                    <div class="alert alert-danger mb-3" role="alert" 
                         invisible="tonnage_restant > 0 or state != 'active'">
                        <i class="fa fa-exclamation-circle"/> 
                        <strong>Tonnage √©puis√© !</strong> Cette CV n'a plus de tonnage disponible.
                    </div>
                    <div class="alert alert-info mb-3" role="alert" 
                         invisible="tonnage_progress &lt; 80 or state != 'active'">
                        <i class="fa fa-info-circle"/> 
                        <strong>Information :</strong> Cette CV est utilis√©e √† 
                        <field name="tonnage_progress" class="fw-bold"/>%. 
                        Pensez √† anticiper une nouvelle CV.
                    </div>
                    
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_customer_orders" type="object" 
                                class="oe_stat_button" icon="fa-handshake-o">
                            <div class="o_stat_info">
                                <field name="customer_order_count" class="o_stat_value"/>
                                <span class="o_stat_text">Contrats</span>
                            </div>
                        </button>
                        <button name="action_view_formules" type="object" 
                                class="oe_stat_button" icon="fa-file-text">
                            <div class="o_stat_info">
                                <field name="formule_count" class="o_stat_value"/>
                                <span class="o_stat_text">Formules</span>
                            </div>
                        </button>
                        <button name="action_create_formule" type="object"
                                class="oe_stat_button" icon="fa-plus-circle"
                                invisible="state != 'active'">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Nouvelle</span>
                                <span class="o_stat_text">Formule</span>
                            </div>
                        </button>
                        <button class="oe_stat_button" icon="fa-line-chart" disabled="1"
                                invisible="tonnage_utilise == 0">
                            <div class="o_stat_info">
                                <field name="tonnage_progress" class="o_stat_value" widget="statinfo"/>
                                <span class="o_stat_text">% Utilis√©</span>
                            </div>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Active" bg_color="bg-success" 
                            invisible="state != 'active'"/>
                    <widget name="web_ribbon" title="Consomm√©e" bg_color="bg-warning" 
                            invisible="state != 'consumed'"/>
                    <widget name="web_ribbon" title="Expir√©e" bg_color="bg-danger" 
                            invisible="state != 'expired'"/>
                    <widget name="web_ribbon" title="Annul√©e" bg_color="bg-secondary" 
                            invisible="state != 'cancelled'"/>
                    
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" readonly="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Section principale avec bordure color√©e -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-body p-3">
                                    <group col="4">
                                        <group string="üìã Identification" colspan="2">
                                            <field name="company_id" invisible="1"/>
                                            <field name="reference_ccc" placeholder="R√©f√©rence CCC officielle"
                                                   class="fw-bold"/>
                                            <field name="campaign_id" 
                                                   options="{'no_create': True, 'no_open': True}"
                                                   readonly="state != 'draft'"/>
                                            <field name="product_type" readonly="state != 'draft'"
                                                   widget="radio" options="{'horizontal': true}"/>
                                        </group>
                                        <group string="üìÖ Validit√©" colspan="2">
                                            <label for="date_emission" string="P√©riode"/>
                                            <div class="o_row">
                                                <field name="date_emission" readonly="state != 'draft'" class="oe_inline"/>
                                                <span class="mx-2">‚Üí</span>
                                                <field name="date_end" readonly="state != 'draft'" class="oe_inline"/>
                                            </div>
                                            <field name="date_start" readonly="state != 'draft'" invisible="1"/>
                                            <field name="days_remaining" 
                                                   decoration-danger="days_remaining &lt;= 7"
                                                   decoration-warning="days_remaining &lt;= 30"
                                                   decoration-success="days_remaining > 30"
                                                   string="Jours restants"/>
                                        </group>
                                    </group>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tonnage avec indicateur visuel pro√©minent -->
                    <group col="2">
                        <group string="üìä Suivi du Tonnage">
                            <div class="alert alert-light p-2 mb-2" role="status">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Progression d'utilisation</span>
                                    <field name="tonnage_progress" widget="progressbar" class="w-50"/>
                                </div>
                            </div>
                            <field name="tonnage_autorise" 
                                   readonly="state != 'draft'"
                                   class="oe_inline fw-bold fs-5"
                                   string="Tonnage autoris√© (T)"/>
                            <field name="tonnage_utilise" readonly="1" 
                                   class="text-primary"
                                   string="Tonnage utilis√© (T)"/>
                            <field name="tonnage_restant" readonly="1"
                                   decoration-danger="tonnage_restant &lt;= 0"
                                   decoration-success="tonnage_restant > 0"
                                   class="fw-bold fs-5"
                                   string="Tonnage disponible (T)"/>
                        </group>
                        <group string="üí∞ Conditions Commerciales">
                            <field name="currency_id" 
                                   options="{'no_create': True}"
                                   readonly="state != 'draft'"
                                   groups="base.group_multi_currency"/>
                            <field name="prix_tonnage" readonly="state != 'draft'"
                                   class="fw-bold"
                                   string="Prix par tonne"/>
                        </group>
                    </group>
                    
                    <group col="2">
                        <group string="üåç Destination Export">
                            <field name="destination_country_id" 
                                   options="{'no_create': True}"
                                   readonly="state != 'draft'"
                                   placeholder="S√©lectionner le pays..."/>
                            <field name="destination_port" readonly="state != 'draft'"
                                   placeholder="Ex: Rotterdam, Anvers..."/>
                        </group>
                        <group string="üè¢ Soci√©t√©">
                            <field name="is_expired" invisible="1"/>
                            <field name="company_id" groups="base.group_multi_company"
                                   readonly="state != 'draft'"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string=" Notes" name="notes">
                            <field name="note" placeholder="Notes et observations..."/>
                        </page>
                        <page string="üìÑ Facture Transitaire" name="forwarding_invoice">
                            <group>
                                <group string="üìé Document joint">
                                    <field name="forwarding_agent_invoice" 
                                           filename="forwarding_agent_invoice_filename"
                                           widget="binary"/>
                                    <field name="forwarding_agent_invoice_filename" invisible="1"/>
                                </group>
                            </group>
                            <!-- Pr√©visualisation du PDF -->
                            <div class="o_invoice_preview mt-3" 
                                 style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;"
                                 invisible="not forwarding_agent_invoice">
                                <field name="forwarding_agent_invoice" 
                                       invisible="not forwarding_agent_invoice"
                                       widget="pdf_viewer"
                                       filename="forwarding_agent_invoice_filename"
                                       nolabel="1"/>
                            </div>
                            <div invisible="forwarding_agent_invoice" class="alert alert-info mt-3" role="alert">
                                <i class="fa fa-info-circle me-2"/>
                                Aucune facture transitaire jointe. Cliquez sur le champ ci-dessus pour t√©l√©verser un fichier (PDF ou image).
                            </div>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="potting_confirmation_vente_view_search" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.search</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <search string="Rechercher CV">
                <field name="name"/>
                <field name="reference_ccc"/>
                <field name="campaign_id"/>
                <field name="destination_country_id"/>
                <separator/>
                <filter string="Brouillon" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Actives" name="active" domain="[('state', '=', 'active')]"/>
                <filter string="Consomm√©es" name="consumed" domain="[('state', '=', 'consumed')]"/>
                <filter string="Expir√©es" name="expired" domain="[('state', '=', 'expired')]"/>
                <separator/>
                <filter string="Tonnage disponible" name="has_tonnage" 
                        domain="[('tonnage_restant', '>', 0)]"/>
                <filter string="Expire bient√¥t (30j)" name="expiring_soon" 
                        domain="[('date_end', '&lt;=', (context_today() + relativedelta(days=30)).strftime('%Y-%m-%d')),
                                 ('date_end', '>=', context_today().strftime('%Y-%m-%d')),
                                 ('state', '=', 'active')]"/>
                <separator/>
                <filter string="Ma soci√©t√©" name="my_company" 
                        domain="[('company_id', '=', context.get('allowed_company_ids', [False])[0])]"/>
                <group expand="0" string="Grouper par">
                    <filter string="√âtat" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Campagne" name="group_campaign" context="{'group_by': 'campaign_id'}"/>
                    <filter string="Type produit" name="group_product" context="{'group_by': 'product_type'}"/>
                    <filter string="Destination" name="group_destination" context="{'group_by': 'destination_country_id'}"/>
                    <filter string="Date √©mission" name="group_date" context="{'group_by': 'date_emission:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="potting_confirmation_vente_view_kanban" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.kanban</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1" default_group_by="state">
                <field name="name"/>
                <field name="reference_ccc"/>
                <field name="campaign_id"/>
                <field name="tonnage_autorise"/>
                <field name="tonnage_restant"/>
                <field name="tonnage_progress"/>
                <field name="prix_tonnage"/>
                <field name="currency_id"/>
                <field name="date_end"/>
                <field name="state"/>
                <field name="customer_order_count"/>
                <field name="formule_count"/>
                <progressbar field="state" 
                             colors='{"draft": "secondary", "active": "success", "consumed": "warning", "expired": "danger", "cancelled": "muted"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top mb-2">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <span t-if="record.reference_ccc.raw_value" 
                                              class="text-muted ms-2">
                                            (<field name="reference_ccc"/>)
                                        </span>
                                    </div>
                                    <field name="state" widget="label_selection" 
                                           options="{'classes': {'draft': 'secondary', 'active': 'success', 'consumed': 'warning', 'expired': 'danger', 'cancelled': 'dark'}}"/>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="mb-1">
                                        <i class="fa fa-calendar text-muted"/> Campagne: 
                                        <field name="campaign_id"/>
                                    </div>
                                    <div class="mb-1">
                                        <i class="fa fa-balance-scale text-muted"/> Tonnage: 
                                        <strong><field name="tonnage_restant"/></strong> / 
                                        <field name="tonnage_autorise"/> T
                                    </div>
                                    <div class="mb-2">
                                        <field name="tonnage_progress" widget="progressbar" 
                                               options="{'editable': false}"/>
                                    </div>
                                    <div class="mb-1">
                                        <i class="fa fa-money text-muted"/> Prix: 
                                        <field name="prix_tonnage" widget="monetary"/> / T
                                    </div>
                                    <div t-if="record.date_end.raw_value" class="text-muted small">
                                        <i class="fa fa-clock-o"/> Expire: <field name="date_end"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <span class="badge bg-info me-1">
                                            <i class="fa fa-file-text-o"/> 
                                            <field name="customer_order_count"/> Contrats
                                        </span>
                                        <span class="badge bg-secondary">
                                            <i class="fa fa-calculator"/> 
                                            <field name="formule_count"/> Formules
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Calendar View -->
    <record id="potting_confirmation_vente_view_calendar" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.calendar</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <calendar string="Confirmations de Vente" date_start="date_start" date_stop="date_end" 
                      color="state" mode="month" quick_create="0">
                <field name="name"/>
                <field name="tonnage_autorise"/>
                <field name="tonnage_restant"/>
            </calendar>
        </field>
    </record>

    <!-- Pivot View -->
    <record id="potting_confirmation_vente_view_pivot" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.pivot</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <pivot string="Analyse CV" sample="1">
                <field name="campaign_id" type="row"/>
                <field name="product_type" type="col"/>
                <field name="tonnage_autorise" type="measure"/>
                <field name="tonnage_utilise" type="measure"/>
                <field name="tonnage_restant" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Graph View -->
    <record id="potting_confirmation_vente_view_graph" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.graph</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="arch" type="xml">
            <graph string="Confirmations de Vente" type="bar" sample="1">
                <field name="campaign_id"/>
                <field name="tonnage_autorise" type="measure"/>
                <field name="tonnage_utilise" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Action -->
    <record id="action_potting_confirmation_vente" model="ir.actions.act_window">
        <field name="name">Confirmations de Vente</field>
        <field name="res_model">potting.confirmation.vente</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph</field>
        <field name="search_view_id" ref="potting_confirmation_vente_view_search"/>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©ez votre premi√®re Confirmation de Vente (CV)
            </p>
            <p>
                Les Confirmations de Vente sont des autorisations d√©livr√©es par le 
                Conseil Caf√©-Cacao pour ex√©cuter des contrats d'exportation.
            </p>
        </field>
    </record>

</odoo>
