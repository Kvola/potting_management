<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ================================================================
         EXTENSION VUES: CV - Transfert de tonnage entre campagnes
         ================================================================ -->

    <!-- Extension de la vue Form CV pour le transfert de tonnage -->
    <record id="potting_confirmation_vente_view_form_transfer" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.form.transfer</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="inherit_id" ref="potting_confirmation_vente_view_form"/>
        <field name="arch" type="xml">
            <!-- Ajout du bouton de transfert dans le header -->
            <xpath expr="//button[@name='action_cancel']" position="before">
                <button name="action_open_transfer_wizard" 
                        type="object" 
                        string="üì¶ Transf√©rer tonnage" 
                        class="btn-secondary"
                        invisible="state not in ('active', 'expired') or tonnage_restant &lt;= 0"
                        groups="potting_management.group_potting_agent_ccc,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
            </xpath>
            
            <!-- Ajout du bouton stat pour le transfert -->
            <xpath expr="//button[@name='action_create_formule']" position="after">
                <button name="action_open_transfer_wizard" type="object"
                        class="oe_stat_button" icon="fa-exchange"
                        invisible="state not in ('active', 'expired') or tonnage_restant &lt;= 0"
                        groups="potting_management.group_potting_agent_ccc,potting_management.group_potting_shipping,potting_management.group_potting_manager">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Transf√©rer</span>
                        <span class="o_stat_text">Tonnage</span>
                    </div>
                </button>
            </xpath>
            
            <!-- Alerte pour CV expir√©e avec tonnage restant -->
            <xpath expr="//div[@class='alert alert-info mb-3']" position="after">
                <div class="alert alert-warning mb-3" role="alert" 
                     invisible="state != 'expired' or tonnage_restant &lt;= 0">
                    <i class="fa fa-exclamation-triangle"/> 
                    <strong>CV Expir√©e avec tonnage restant !</strong> 
                    Il reste <field name="tonnage_restant" class="fw-bold"/> tonnes disponibles. 
                    Vous pouvez transf√©rer ce tonnage vers une nouvelle CV.
                    <button name="action_open_transfer_wizard" type="object" 
                            class="btn btn-sm btn-warning ms-2" string="Transf√©rer maintenant"
                            groups="potting_management.group_potting_agent_ccc,potting_management.group_potting_shipping,potting_management.group_potting_manager"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Extension de la vue Tree pour indicateur transfert possible -->
    <record id="potting_confirmation_vente_view_tree_transfer" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.tree.transfer</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="inherit_id" ref="potting_confirmation_vente_view_tree"/>
        <field name="arch" type="xml">
            <!-- Ajout action header transfert -->
            <xpath expr="//header/button[@name='action_activate']" position="after">
                <button name="action_open_transfer_wizard" type="object" 
                        string="Transf√©rer tonnage" class="btn-secondary"/>
            </xpath>
        </field>
    </record>

    <!-- Extension de la recherche pour filtre transfert possible -->
    <record id="potting_confirmation_vente_view_search_transfer" model="ir.ui.view">
        <field name="name">potting.confirmation.vente.search.transfer</field>
        <field name="model">potting.confirmation.vente</field>
        <field name="inherit_id" ref="potting_confirmation_vente_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='expired']" position="after">
                <filter string="Tonnage transf√©rable" name="transferable" 
                        domain="[('state', 'in', ['expired', 'active']), ('tonnage_restant', '>', 0)]"/>
            </xpath>
        </field>
    </record>

    <!-- Action pour Agent CCC - Gestion CV -->
    <record id="action_potting_cv_agent_ccc" model="ir.actions.act_window">
        <field name="name">Confirmations de Vente</field>
        <field name="res_model">potting.confirmation.vente</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="context">{
            'search_default_active': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©er une nouvelle Confirmation de Vente
            </p>
            <p>
                Les CV sont √©mises par le CCC et autorisent l'export d'un tonnage de cacao.
            </p>
        </field>
    </record>

</odoo>
