<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <!-- OT Manager Dashboard Template -->
    <t t-name="potting_management.OtManagerDashboard">
        <div class="o_potting_dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fa fa-truck me-2"/>Tableau de bord Gestionnaire OT
                </h1>
                <p class="dashboard-subtitle">Création et gestion des Ordres de Transit</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions mb-4">
                <button class="btn btn-primary" t-on-click="createOT" title="Créer un nouvel OT manuellement">
                    <i class="fa fa-plus me-1"/>Nouvel OT
                </button>
                <button class="btn btn-success" t-on-click="openCreateOTWizard" title="Générer un OT depuis un contrat existant">
                    <i class="fa fa-magic me-1"/>Générer depuis Contrat
                </button>
                <button class="btn btn-outline-primary" t-on-click="openAllocations" title="Gérer les allocations OT-Contrats">
                    <i class="fa fa-link me-1"/>Allocations
                </button>
                <button class="btn btn-outline-secondary" t-on-click="openCampaigns" title="Voir les campagnes">
                    <i class="fa fa-calendar me-1"/>Campagnes
                </button>
            </div>

            <!-- Current Campaign Banner -->
            <t t-if="state.currentCampaign">
                <div class="mb-4">
                    <div class="card campaign-banner bg-light">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <small class="text-muted">Campagne active</small>
                                    <h5 class="mb-0 text-primary">
                                        <i class="fa fa-calendar-check-o me-1"/>
                                        <t t-esc="state.currentCampaign.name"/>
                                    </h5>
                                </div>
                                <div class="col-md-8">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">Période</small>
                                            <div class="fw-bold small">
                                                <t t-esc="state.currentCampaign.date_start"/> - <t t-esc="state.currentCampaign.date_end"/>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Nombre d'OT</small>
                                            <div class="fw-bold text-primary">
                                                <t t-esc="state.currentCampaign.transit_order_count"/>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Tonnage total</small>
                                            <div class="fw-bold text-success">
                                                <t t-esc="formatNumber(state.currentCampaign.total_tonnage, 0)"/> T
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Global Tonnage Overview -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-balance-scale"/>Allocation globale du tonnage
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card border-accent-primary">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="formatNumber(state.tonnageStats.contract_total, 0)"/>
                                <div class="stat-label">Tonnage contracté (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-accent-warning">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="formatNumber(state.tonnageStats.ot_total, 0)"/>
                                <div class="stat-label">Tonnage en OT (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-accent-success">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="formatNumber(state.tonnageStats.available, 0)"/>
                                <div class="stat-label">Disponible (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="formatNumber(state.tonnageStats.percentage_allocated, 1)"/>
                                <div class="stat-label">% Alloué</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Progress bar -->
                <div class="card mt-3">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted small">Progression allocation OT</span>
                            <span class="fw-bold"><t t-esc="formatNumber(state.tonnageStats.percentage_allocated, 1)"/>%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" 
                                 t-attf-style="width: #{Math.min(state.tonnageStats.percentage_allocated, 100)}%"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OT Statistics by State -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-list-alt"/>État des Ordres de Transit
                </div>
                <div class="row g-3">
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="() => this.openOTs('draft')">
                            <div class="stat-card">
                                <div class="stat-value text-secondary" t-esc="state.otStats.draft"/>
                                <div class="stat-label small">Brouillon</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-info" t-on-click="() => this.openOTs('confirmed')">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="state.otStats.confirmed"/>
                                <div class="stat-label small">Confirmé</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-primary" t-on-click="() => this.openOTs('formule_linked')">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="state.otStats.formule_linked"/>
                                <div class="stat-label small">Formule liée</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-warning" t-on-click="() => this.openOTs('in_progress')">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="state.otStats.in_progress"/>
                                <div class="stat-label small">Production</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="() => this.openOTs('ready_validation')">
                            <div class="stat-card">
                                <div class="stat-value text-purple" t-esc="state.otStats.ready_validation"/>
                                <div class="stat-label small">À valider</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-success" t-on-click="() => this.openOTs('done')">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="state.otStats.done"/>
                                <div class="stat-label small">Terminé</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two columns: Recent OTs & Available Contracts -->
            <div class="row g-4 mb-4">
                <!-- Recent OTs -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-truck me-2"/>OT récents à traiter</span>
                            <button class="btn btn-sm btn-light" t-on-click="() => this.openOTs()">
                                Voir tous
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.recentOTs.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Référence</th>
                                                <th>Produit</th>
                                                <th class="text-end">Tonnage</th>
                                                <th>État</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.recentOTs" t-as="ot" t-key="ot.id">
                                                <tr class="cursor-pointer" t-on-click="() => this.openOT(ot.id)">
                                                    <td>
                                                        <strong t-esc="ot.name"/>
                                                    </td>
                                                    <td>
                                                        <small t-esc="getProductTypeLabel(ot.product_type)"/>
                                                    </td>
                                                    <td class="text-end">
                                                        <t t-esc="formatNumber(ot.tonnage, 2)"/> T
                                                    </td>
                                                    <td>
                                                        <span t-att-class="getStateBadgeClass(ot.state)">
                                                            <t t-esc="getStateLabel(ot.state)"/>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="p-4 text-center text-muted">
                                    <i class="fa fa-inbox fa-2x mb-2"/>
                                    <p>Aucun OT à traiter</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Available Contracts -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-file-text me-2"/>Contrats avec tonnage disponible</span>
                            <button class="btn btn-sm btn-light" t-on-click="openContracts">
                                Voir tous
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.contractsAvailable.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Contrat</th>
                                                <th>Client</th>
                                                <th class="text-end">Disponible</th>
                                                <th class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.contractsAvailable" t-as="contract" t-key="contract.id">
                                                <tr class="cursor-pointer" t-on-click="() => this.openContract(contract.id)">
                                                    <td>
                                                        <strong t-esc="contract.name"/>
                                                    </td>
                                                    <td>
                                                        <small t-esc="contract.customer_id ? contract.customer_id[1] : '-'"/>
                                                    </td>
                                                    <td class="text-end text-success fw-bold">
                                                        <t t-esc="formatNumber(contract.remaining_contract_tonnage, 2)"/> T
                                                    </td>
                                                    <td class="text-end">
                                                        <t t-esc="formatNumber(contract.contract_tonnage, 2)"/> T
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="p-4 text-center text-muted">
                                    <i class="fa fa-check-circle fa-2x mb-2 text-success"/>
                                    <p>Tous les contrats sont entièrement alloués</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Type Statistics -->
            <t t-if="state.productStats.length > 0">
                <div class="mb-4">
                    <div class="section-title">
                        <i class="fa fa-pie-chart"/>Répartition par type de produit
                    </div>
                    <div class="row g-3">
                        <t t-foreach="state.productStats" t-as="product" t-key="product.type">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="mb-1" t-esc="getProductTypeLabel(product.type)"/>
                                        <div class="d-flex justify-content-around mt-2">
                                            <div>
                                                <div class="stat-value text-primary" t-esc="product.count"/>
                                                <small class="text-muted">OT</small>
                                            </div>
                                            <div>
                                                <div class="stat-value text-success" t-esc="formatNumber(product.tonnage, 0)"/>
                                                <small class="text-muted">Tonnes</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </t>

            <!-- Recent Allocations -->
            <t t-if="state.activeAllocations.length > 0">
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-link me-2"/>Allocations OT-Contrats récentes</span>
                            <button class="btn btn-sm btn-light" t-on-click="openAllocations">
                                Gérer les allocations
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>OT</th>
                                            <th>Contrat</th>
                                            <th class="text-end">Tonnage alloué</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.activeAllocations" t-as="alloc" t-key="alloc.id">
                                            <tr>
                                                <td t-esc="alloc.transit_order_id ? alloc.transit_order_id[1] : '-'"/>
                                                <td t-esc="alloc.customer_order_id ? alloc.customer_order_id[1] : '-'"/>
                                                <td class="text-end fw-bold">
                                                    <t t-esc="formatNumber(alloc.tonnage_alloue, 2)"/> T
                                                </td>
                                                <td>
                                                    <small t-esc="formatDate(alloc.create_date)"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>
