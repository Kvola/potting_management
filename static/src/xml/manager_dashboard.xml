<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <!-- Dashboard Responsable (Manager) -->
    <t t-name="potting_management.ManagerDashboard">
        <div class="o_potting_dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fa fa-dashboard me-2"/>Tableau de bord Responsable
                </h1>
                <p class="dashboard-subtitle">Vue globale des opérations d'exportation</p>
            </div>

            <!-- Actions rapides -->
            <div class="quick-actions mb-4">
                <button class="btn btn-primary" t-on-click="openContracts">
                    <i class="fa fa-file-text me-1"/>Contrats
                </button>
                <button class="btn btn-info" t-on-click="openTransitOrders">
                    <i class="fa fa-truck me-1"/>Ordres de Transit
                </button>
                <button class="btn btn-success" t-on-click="openLots">
                    <i class="fa fa-cubes me-1"/>Lots
                </button>
                <button class="btn btn-warning" t-on-click="openCVs">
                    <i class="fa fa-certificate me-1"/>CV
                </button>
                <button class="btn btn-secondary" t-on-click="openFormules">
                    <i class="fa fa-file me-1"/>Formules
                </button>
                <button class="btn btn-outline-dark" t-on-click="openSettings">
                    <i class="fa fa-cog me-1"/>Paramètres
                </button>
            </div>

            <!-- Campagne active -->
            <t t-if="state.currentCampaign">
                <div class="mb-4">
                    <div class="card campaign-banner bg-gradient-primary text-white">
                        <div class="card-body py-3">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="small text-white-50">Campagne active</div>
                                    <h3 class="mb-0">
                                        <t t-esc="state.currentCampaign.name"/>
                                    </h3>
                                </div>
                                <div class="col-md-8">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <small class="text-white-50">Code</small>
                                            <div class="fw-bold"><t t-esc="state.currentCampaign.code"/></div>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-white-50">Droits export</small>
                                            <div class="fw-bold"><t t-esc="formatNumber(state.currentCampaign.export_duty_rate, 1)"/>%</div>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-white-50">Nombre OT</small>
                                            <div class="fw-bold"><t t-esc="state.currentCampaign.transit_order_count"/></div>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-white-50">Tonnage total</small>
                                            <div class="fw-bold"><t t-esc="formatNumber(state.currentCampaign.total_tonnage, 0)"/> T</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- ========== ALERTES ========== -->
            <t t-if="state.alerts.cv_expiring > 0 || state.alerts.invoices_to_validate > 0 || state.alerts.ot_to_validate > 0 || state.alerts.formules_unpaid > 0">
                <div class="mb-4">
                    <div class="row g-2">
                        <t t-if="state.alerts.ot_to_validate > 0">
                            <div class="col-md-3">
                                <div class="alert alert-warning mb-0 cursor-pointer" role="status" t-on-click="openOTToValidate">
                                    <i class="fa fa-exclamation-circle me-2"/>
                                    <strong><t t-esc="state.alerts.ot_to_validate"/></strong> OT à valider
                                </div>
                            </div>
                        </t>
                        <t t-if="state.alerts.invoices_to_validate > 0">
                            <div class="col-md-3">
                                <div class="alert alert-info mb-0 cursor-pointer" role="status" t-on-click="openInvoicesToValidate">
                                    <i class="fa fa-file-text me-2"/>
                                    <strong><t t-esc="state.alerts.invoices_to_validate"/></strong> factures à valider
                                </div>
                            </div>
                        </t>
                        <t t-if="state.alerts.cv_expiring > 0">
                            <div class="col-md-3">
                                <div class="alert alert-danger mb-0 cursor-pointer" role="status" t-on-click="openExpiringCVs">
                                    <i class="fa fa-clock-o me-2"/>
                                    <strong><t t-esc="state.alerts.cv_expiring"/></strong> CV expire(nt) bientôt
                                </div>
                            </div>
                        </t>
                        <t t-if="state.alerts.formules_unpaid > 0">
                            <div class="col-md-3">
                                <div class="alert alert-secondary mb-0 cursor-pointer" role="status" t-on-click="openUnpaidFormules">
                                    <i class="fa fa-money me-2"/>
                                    <strong><t t-esc="state.alerts.formules_unpaid"/></strong> formules impayées
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </t>

            <!-- ========== KPIs GLOBAUX ========== -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-tachometer"/>Indicateurs clés
                </div>
                <div class="row g-3">
                    <div class="col-md-2">
                        <div class="card h-100 cursor-pointer" t-on-click="openContracts">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="state.globalKPIs.total_contracts"/>
                                <div class="stat-label">Contrats</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 cursor-pointer" t-on-click="openTransitOrders">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="state.globalKPIs.total_ot"/>
                                <div class="stat-label">Ordres de Transit</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100">
                            <div class="stat-card">
                                <div class="stat-value text-success">
                                    <t t-esc="formatNumber(state.globalKPIs.total_tonnage_contracted, 0)"/>
                                </div>
                                <div class="stat-label">Tonnage contracté (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100">
                            <div class="stat-card">
                                <div class="stat-value text-warning">
                                    <t t-esc="formatNumber(state.globalKPIs.total_tonnage_shipped, 0)"/>
                                </div>
                                <div class="stat-label">Tonnage expédié (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted small">Taux d'expédition</span>
                                    <span class="fw-bold"><t t-esc="formatNumber(state.globalKPIs.shipping_rate, 1)"/>%</span>
                                </div>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-success" 
                                         t-attf-style="width: #{Math.min(state.globalKPIs.shipping_rate, 100)}%"/>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted"><t t-esc="formatNumber(state.globalKPIs.total_tonnage_shipped, 0)"/> T</small>
                                    <small class="text-muted"><t t-esc="formatNumber(state.globalKPIs.total_tonnage_contracted, 0)"/> T</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== CONTRATS / OT / LOTS ========== -->
            <div class="row g-3 mb-4">
                <!-- Contrats par état -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-file-text me-2"/>Contrats par état
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openContractsByState('draft')">
                                    <span><i class="fa fa-circle text-secondary me-2"/>Brouillon</span>
                                    <span class="badge bg-secondary"><t t-esc="state.contractStats.draft"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openContractsByState('confirmed')">
                                    <span><i class="fa fa-circle text-primary me-2"/>Confirmés</span>
                                    <span class="badge bg-primary"><t t-esc="state.contractStats.confirmed"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openContractsByState('in_progress')">
                                    <span><i class="fa fa-circle text-info me-2"/>En cours</span>
                                    <span class="badge bg-info"><t t-esc="state.contractStats.in_progress"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openContractsByState('done')">
                                    <span><i class="fa fa-circle text-success me-2"/>Terminés</span>
                                    <span class="badge bg-success"><t t-esc="state.contractStats.done"/></span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OT par état -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-truck me-2"/>OT par état
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openOTByState('draft')">
                                    <span><i class="fa fa-circle text-secondary me-2"/>Brouillon</span>
                                    <span class="badge bg-secondary"><t t-esc="state.otStats.draft"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openOTByState('lots_generated')">
                                    <span><i class="fa fa-circle text-info me-2"/>Lots générés</span>
                                    <span class="badge bg-info"><t t-esc="state.otStats.lots_generated"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openOTByState('in_progress')">
                                    <span><i class="fa fa-circle text-primary me-2"/>En cours</span>
                                    <span class="badge bg-primary"><t t-esc="state.otStats.in_progress"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openOTByState('ready_validation')">
                                    <span><i class="fa fa-circle text-warning me-2"/>À valider</span>
                                    <span class="badge bg-warning"><t t-esc="state.otStats.ready_validation"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openOTByState('done')">
                                    <span><i class="fa fa-circle text-success me-2"/>Terminés</span>
                                    <span class="badge bg-success"><t t-esc="state.otStats.done"/></span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lots par état -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-cubes me-2"/>Lots par état
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openLotsByState('draft')">
                                    <span><i class="fa fa-circle text-secondary me-2"/>Brouillon</span>
                                    <span class="badge bg-secondary"><t t-esc="state.lotStats.draft"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openLotsByState('in_production')">
                                    <span><i class="fa fa-circle text-warning me-2"/>En production</span>
                                    <span class="badge bg-warning"><t t-esc="state.lotStats.in_production"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openLotsByState('ready')">
                                    <span><i class="fa fa-circle text-primary me-2"/>Prêts</span>
                                    <span class="badge bg-primary"><t t-esc="state.lotStats.ready"/></span>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex justify-content-between cursor-pointer"
                                   t-on-click="() => this.openLotsByState('potted')">
                                    <span><i class="fa fa-circle text-success me-2"/>Empotés</span>
                                    <span class="badge bg-success"><t t-esc="state.lotStats.potted"/></span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== FINANCES ========== -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-money"/>Vue financière
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="stat-card">
                                <div class="stat-value text-primary">
                                    <t t-esc="formatCurrency(state.financeStats.contract_value_xof)"/>
                                    <small class="ms-1">FCFA</small>
                                </div>
                                <div class="stat-label">Valeur des contrats</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 border-accent-warning cursor-pointer" t-on-click="openInvoices">
                            <div class="stat-card">
                                <div class="stat-value text-warning">
                                    <t t-esc="formatCurrency(state.financeStats.invoices_pending)"/>
                                    <small class="ms-1">FCFA</small>
                                </div>
                                <div class="stat-label">Factures transitaires en attente</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 border-accent-danger cursor-pointer" t-on-click="openUnpaidFormules">
                            <div class="stat-card">
                                <div class="stat-value text-danger">
                                    <t t-esc="formatCurrency(state.financeStats.formules_pending)"/>
                                    <small class="ms-1">FCFA</small>
                                </div>
                                <div class="stat-label">Formules à reverser</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 border-accent-success">
                            <div class="stat-card">
                                <div class="stat-value text-success">
                                    <t t-esc="formatCurrency(state.financeStats.formules_paid)"/>
                                    <small class="ms-1">FCFA</small>
                                </div>
                                <div class="stat-label">Formules reversées</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== CV Stats & Top Clients ========== -->
            <div class="row g-3 mb-4">
                <!-- CV Stats -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-certificate me-2"/>Confirmations de Vente</span>
                            <button class="btn btn-sm btn-link" t-on-click="openCVs">Voir tout</button>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="p-2 bg-light rounded text-center">
                                        <div class="fs-4 fw-bold text-primary"><t t-esc="state.cvStats.total"/></div>
                                        <small class="text-muted">Total CV</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-success bg-opacity-10 rounded text-center">
                                        <div class="fs-4 fw-bold text-success"><t t-esc="state.cvStats.active"/></div>
                                        <small class="text-muted">Actives</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-danger bg-opacity-10 rounded text-center cursor-pointer" t-on-click="openExpiringCVs">
                                        <div class="fs-4 fw-bold text-danger"><t t-esc="state.cvStats.expiring_soon"/></div>
                                        <small class="text-muted">Expire &lt; 30j</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-secondary bg-opacity-10 rounded text-center">
                                        <div class="fs-4 fw-bold text-secondary"><t t-esc="state.cvStats.expired"/></div>
                                        <small class="text-muted">Expirées</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Clients -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-trophy me-2"/>Top 5 Clients (par tonnage)
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.topCustomers.length > 0">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Client</th>
                                            <th class="text-end">Tonnage (T)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.topCustomers" t-as="customer" t-key="customer_index">
                                            <tr class="cursor-pointer" t-on-click="() => this.openCustomerContracts(customer.customer_id)">
                                                <td>
                                                    <span t-attf-class="badge #{customer_index == 0 ? 'bg-warning' : customer_index == 1 ? 'bg-secondary' : customer_index == 2 ? 'bg-danger' : 'bg-light text-dark'}">
                                                        <t t-esc="customer_index + 1"/>
                                                    </span>
                                                </td>
                                                <td><t t-esc="customer.customer"/></td>
                                                <td class="text-end fw-bold"><t t-esc="formatNumber(customer.tonnage, 0)"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>
                            <t t-else="">
                                <div class="p-3 text-center text-muted">
                                    <p class="mb-0">Aucune donnée disponible</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== Activités récentes ========== -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-history"/>Activités récentes
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <t t-if="state.recentActivities.length > 0">
                            <div class="list-group list-group-flush">
                                <t t-foreach="state.recentActivities" t-as="activity" t-key="activity_index">
                                    <div class="list-group-item d-flex align-items-center">
                                        <div t-attf-class="rounded-circle bg-#{activity.color} text-white p-2 me-3">
                                            <i t-attf-class="fa #{activity.icon}"/>
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong><t t-esc="activity.reference"/></strong>
                                            <span t-attf-class="badge ms-2 #{getStateClass(activity.state)}">
                                                <t t-esc="getStateLabel(activity.state)"/>
                                            </span>
                                            <div class="small text-muted">
                                                <t t-if="activity.type === 'ot'">Ordre de Transit</t>
                                                <t t-if="activity.type === 'contract'">Contrat</t>
                                                - <t t-esc="formatNumber(activity.value, 0)"/> T
                                            </div>
                                        </div>
                                        <div class="text-muted small">
                                            <t t-esc="formatDateTime(activity.date)"/>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="p-3 text-center text-muted">
                                <p class="mb-0">Aucune activité récente</p>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>
