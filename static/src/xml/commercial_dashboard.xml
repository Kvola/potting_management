<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <!-- Commercial Dashboard Template -->
    <t t-name="potting_management.CommercialDashboard">
        <div class="o_potting_dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fa fa-briefcase me-2"/>Tableau de bord Commercial
                </h1>
                <p class="dashboard-subtitle">Gestion des contrats et suivi des ventes</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions mb-4">
                <button class="btn btn-primary" t-on-click="createContract">
                    <i class="fa fa-plus me-1"/>Nouveau contrat
                </button>
                <button class="btn btn-secondary" t-on-click="importContracts">
                    <i class="fa fa-upload me-1"/>Importer contrats
                </button>
                <button class="btn btn-outline-primary" t-on-click="openCampaigns">
                    <i class="fa fa-calendar me-1"/>Campagnes
                </button>
            </div>

            <!-- Current Campaign Banner -->
            <t t-if="state.currentCampaign">
                <div class="mb-4">
                    <div class="card campaign-banner">
                        <div class="card-body py-3">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="section-title mb-0">
                                        <i class="fa fa-calendar-check-o"/>
                                        Campagne active
                                    </div>
                                    <h4 class="mb-0 mt-1 text-primary">
                                        <t t-esc="state.currentCampaign.name"/>
                                    </h4>
                                </div>
                                <div class="col-md-8">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">Droits d'export</small>
                                            <div class="fw-bold">
                                                <t t-esc="formatNumber(state.currentCampaign.export_duty_rate, 1)"/> %
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Nombre d'OT</small>
                                            <div class="fw-bold">
                                                <t t-esc="state.currentCampaign.transit_order_count"/>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Tonnage total</small>
                                            <div class="fw-bold">
                                                <t t-esc="formatNumber(state.currentCampaign.total_tonnage, 0)"/> T
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Global Tonnage Overview -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-balance-scale"/>Aper√ßu global du tonnage
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="formatNumber(state.tonnage.contract_total, 0)"/>
                                <div class="stat-label">Tonnage contract√© (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-accent-warning">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="formatNumber(state.tonnage.ot_total, 0)"/>
                                <div class="stat-label">Tonnage utilis√© (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-accent-success">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="formatNumber(state.tonnage.remaining, 0)"/>
                                <div class="stat-label">Tonnage restant (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="formatNumber(state.tonnage.percentage_used, 1)"/>
                                <div class="stat-label">% Utilisation</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Global progress bar -->
                <div class="card mt-3">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted small">Progression globale</span>
                            <span class="fw-bold"><t t-esc="formatNumber(state.tonnage.percentage_used, 1)"/>%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" 
                                 t-attf-style="width: #{Math.min(state.tonnage.percentage_used, 100)}%"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Amounts Overview (NEW) -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-money"/>Aper√ßu des montants
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card border-accent-primary">
                            <div class="stat-card">
                                <div class="stat-value text-primary">
                                    <t t-esc="formatCurrency(state.amounts.total_contract)"/>
                                    <small class="ms-1" t-esc="state.amounts.currency_symbol || '‚Ç¨'"/>
                                </div>
                                <div class="stat-label">Montant total des contrats (devise contrat)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-accent-success">
                            <div class="stat-card">
                                <div class="stat-value text-success">
                                    <t t-esc="formatCurrency(state.amounts.total_company_currency)"/>
                                    <small class="ms-1" t-esc="state.amounts.company_currency_symbol || 'XOF'"/>
                                </div>
                                <div class="stat-label">üí± Montant converti (devise soci√©t√©)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contract Statistics -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-file-text-o"/>√âtat des contrats
                </div>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer" t-on-click="() => this.openContracts('draft')">
                            <div class="stat-card">
                                <div class="stat-value text-secondary" t-esc="state.contracts.draft"/>
                                <div class="stat-label">Brouillon</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-info" t-on-click="() => this.openContracts('confirmed')">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="state.contracts.confirmed"/>
                                <div class="stat-label">Confirm√©s</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-warning" t-on-click="() => this.openContracts('in_progress')">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="state.contracts.in_progress"/>
                                <div class="stat-label">En cours</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-success" t-on-click="() => this.openContracts('done')">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="state.contracts.done"/>
                                <div class="stat-label">Termin√©s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CV (Confirmation de Vente) Statistics - NEW -->
            <div class="mb-4">
                <div class="section-title d-flex justify-content-between align-items-center">
                    <span><i class="fa fa-certificate"/>Confirmations de Vente (CV)</span>
                    <button class="btn btn-sm btn-outline-primary" t-on-click="createCV">
                        <i class="fa fa-plus me-1"/>Nouvelle CV
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="() => this.openCVs()">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="state.cvStats.total"/>
                                <div class="stat-label">Total CV</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-success" t-on-click="() => this.openCVs('active')">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="state.cvStats.active"/>
                                <div class="stat-label">Actives</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-warning" t-on-click="() => this.openCVs('consumed')">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="state.cvStats.consumed"/>
                                <div class="stat-label">Consomm√©es</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-danger" t-on-click="() => this.openCVs('expired')">
                            <div class="stat-card">
                                <div class="stat-value text-danger" t-esc="state.cvStats.expired"/>
                                <div class="stat-label">Expir√©es</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="openCVsExpiringSoon">
                            <div class="stat-card">
                                <div t-attf-class="stat-value #{state.cvStats.expiring_soon > 0 ? 'text-warning' : 'text-muted'}" 
                                     t-esc="state.cvStats.expiring_soon"/>
                                <div class="stat-label">Expire &lt;30j</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="formatNumber(state.cvStats.tonnage_restant, 0)"/>
                                <div class="stat-label">Tonnage dispo (T)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formule (FO) Statistics - NEW -->
            <div class="mb-4">
                <div class="section-title d-flex justify-content-between align-items-center">
                    <span><i class="fa fa-calculator"/>Formules (FO)</span>
                    <button class="btn btn-sm btn-outline-primary" t-on-click="createFormule">
                        <i class="fa fa-plus me-1"/>Nouvelle Formule
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="() => this.openFormules()">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="state.formuleStats.total"/>
                                <div class="stat-label">Total FO</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="() => this.openFormules('draft')">
                            <div class="stat-card">
                                <div class="stat-value text-secondary" t-esc="state.formuleStats.draft"/>
                                <div class="stat-label">Brouillon</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-info" t-on-click="() => this.openFormules('validated')">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="state.formuleStats.validated"/>
                                <div class="stat-label">Valid√©es</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-warning" t-on-click="() => this.openFormules('partial_paid')">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="state.formuleStats.partial_paid"/>
                                <div class="stat-label">Part. pay√©es</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer border-accent-success" t-on-click="() => this.openFormules('paid')">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="state.formuleStats.paid"/>
                                <div class="stat-label">Enti√®r. pay√©es</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="card cursor-pointer" t-on-click="openFormulesAwaitingPayment">
                            <div class="stat-card">
                                <div t-attf-class="stat-value #{state.formuleStats.awaiting_payment > 0 ? 'text-warning' : 'text-muted'}" 
                                     t-esc="state.formuleStats.awaiting_payment"/>
                                <div class="stat-label">En att. paiement</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Formule payment progress -->
                <t t-if="state.formuleStats.total_montant > 0">
                    <div class="card mt-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Progression des paiements Formules</span>
                                <span class="fw-bold">
                                    <t t-esc="formatCurrency(state.formuleStats.total_paye)"/> / 
                                    <t t-esc="formatCurrency(state.formuleStats.total_montant)"/> FCFA
                                </span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-success" 
                                     t-attf-style="width: #{Math.min((state.formuleStats.total_paye / state.formuleStats.total_montant) * 100, 100)}%"/>
                            </div>
                        </div>
                    </div>
                </t>
            </div>

            <!-- Product Type Statistics -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-pie-chart"/>Statistiques par type de produit
                </div>
                <div class="row g-3">
                    <t t-foreach="state.productStats" t-as="product" t-key="product.type">
                        <div class="col-md-6 col-lg-3">
                            <div class="card cursor-pointer h-100" 
                                 t-on-click="() => this.openContractsByProduct(product.type)">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="product-stat-label">
                                            <i t-attf-class="fa #{getProductTypeIcon(product.type)} me-1"/>
                                            <t t-esc="product.label"/>
                                        </div>
                                        <span class="badge bg-secondary">
                                            <t t-esc="product.count"/> contrats
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between small text-muted mb-1">
                                            <span>Contract√©</span>
                                            <span><t t-esc="formatNumber(product.contractTonnage, 0)"/> T</span>
                                        </div>
                                        <div class="d-flex justify-content-between small text-muted mb-1">
                                            <span>Utilis√©</span>
                                            <span><t t-esc="formatNumber(product.usedTonnage, 0)"/> T</span>
                                        </div>
                                        <div class="d-flex justify-content-between small fw-bold">
                                            <span>Restant</span>
                                            <span class="text-success">
                                                <t t-esc="formatNumber(product.remainingTonnage, 0)"/> T
                                            </span>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div t-attf-class="progress-bar #{product.percentage >= 100 ? 'bg-danger' : product.percentage >= 75 ? 'bg-warning' : 'bg-success'}" 
                                             t-attf-style="width: #{Math.min(product.percentage, 100)}%"/>
                                    </div>
                                    <div class="text-end small text-muted mt-1">
                                        <t t-esc="formatNumber(product.percentage, 0)"/>% utilis√©
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
            </div>

            <!-- Main Content Row -->
            <div class="row g-3 mb-4">
                <!-- Recent Contracts -->
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-clock-o me-2"/>Contrats r√©cents
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.recentContracts.length > 0">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>R√©f</th>
                                            <th>Client</th>
                                            <th>Produit</th>
                                            <th>Tonnage</th>
                                            <th>Prix</th>
                                            <th>√âtat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.recentContracts" t-as="contract" t-key="contract.id">
                                            <tr>
                                                <td><strong t-esc="contract.name"/></td>
                                                <td t-esc="contract.customer_id ? contract.customer_id[1] : '-'"/>
                                                <td t-esc="getProductTypeLabel(contract.product_type)"/>
                                                <td>
                                                    <t t-esc="formatNumber(contract.total_tonnage || 0, 2)"/>
                                                    <span class="text-muted">/</span>
                                                    <t t-esc="formatNumber(contract.contract_tonnage || 0, 2)"/> T
                                                </td>
                                                <td><t t-esc="formatNumber(contract.unit_price || 0, 0)"/> ‚Ç¨</td>
                                                <td>
                                                    <span t-attf-class="badge #{getStateBadgeClass(contract.state)}"
                                                          t-esc="getStateLabel(contract.state)"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>
                            <t t-else="">
                                <div class="empty-state">
                                    <i class="fa fa-inbox"/>
                                    <p>Aucun contrat r√©cent</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fa fa-users me-2"/>Top clients
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.customerStats.length > 0">
                                <div class="list-group list-group-flush">
                                    <t t-foreach="state.customerStats" t-as="customer" t-key="customer_index">
                                        <div class="list-group-item cursor-pointer" 
                                             t-on-click="() => this.openContractsByCustomer(customer.customerId)">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="fw-bold text-truncate" style="max-width: 60%;">
                                                    <t t-esc="customer.customer"/>
                                                </div>
                                                <small class="text-muted">
                                                    <t t-esc="formatNumber(customer.contractTonnage, 0)"/> T
                                                </small>
                                            </div>
                                            <div class="progress mt-2" style="height: 4px;">
                                                <div class="progress-bar bg-primary" 
                                                     t-attf-style="width: #{Math.min(customer.percentage, 100)}%"/>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small class="text-muted">Utilis√©</small>
                                                <small><t t-esc="formatNumber(customer.percentage, 0)"/>%</small>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="empty-state">
                                    <i class="fa fa-users"/>
                                    <p>Aucune donn√©e client</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>
