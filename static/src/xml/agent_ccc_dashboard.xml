<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <!-- Agent CCC Dashboard Template -->
    <t t-name="potting_management.AgentCCCDashboard">
        <div class="o_potting_dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fa fa-file-text-o me-2"/>Tableau de bord Agent CCC
                </h1>
                <p class="dashboard-subtitle">Gestion des Confirmations de Vente (CV)</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions mb-4">
                <button class="btn btn-primary" t-on-click="createCV" title="Créer une nouvelle Confirmation de Vente">
                    <i class="fa fa-plus me-1"/>Nouvelle CV
                </button>
                <button class="btn btn-warning" t-on-click="openTonnageTransferWizard" title="Transférer du tonnage entre CV">
                    <i class="fa fa-exchange me-1"/>Transfert tonnage
                </button>
                <button class="btn btn-outline-secondary" t-on-click="openCampaigns" title="Voir les campagnes">
                    <i class="fa fa-calendar me-1"/>Campagnes
                </button>
            </div>

            <!-- Alert: Expiring CVs -->
            <t t-if="state.cvStats.expiring_soon > 0">
                <div class="alert alert-warning mb-4" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-exclamation-triangle fa-2x me-3"/>
                        <div>
                            <h5 class="mb-1">⚠️ Attention: CV expirant bientôt</h5>
                            <p class="mb-0">
                                <strong t-esc="state.cvStats.expiring_soon"/> CV expire(nt) dans les 30 prochains jours.
                                <a href="#" t-on-click.prevent="openExpiringCVs" class="alert-link ms-2">
                                    Voir les CV concernées →
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Current Campaign Banner -->
            <t t-if="state.currentCampaign">
                <div class="mb-4">
                    <div class="card campaign-banner bg-light">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Campagne active</small>
                                    <h5 class="mb-0 text-primary">
                                        <i class="fa fa-calendar-check-o me-1"/>
                                        <t t-esc="state.currentCampaign.name"/>
                                    </h5>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">Période</small>
                                    <span><t t-esc="state.currentCampaign.date_start"/> - <t t-esc="state.currentCampaign.date_end"/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- CV Statistics by State -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-list-alt"/>État des Confirmations de Vente
                </div>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer" t-on-click="() => this.openCVs('draft')">
                            <div class="stat-card">
                                <div class="stat-value text-secondary" t-esc="state.cvStats.draft"/>
                                <div class="stat-label">Brouillon</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-success" t-on-click="() => this.openCVs('active')">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="state.cvStats.active"/>
                                <div class="stat-label">Active</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-danger" t-on-click="() => this.openCVs('expired')">
                            <div class="stat-card">
                                <div class="stat-value text-danger" t-esc="state.cvStats.expired"/>
                                <div class="stat-label">Expirée</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card cursor-pointer border-accent-info" t-on-click="() => this.openCVs('consumed')">
                            <div class="stat-card">
                                <div class="stat-value text-info" t-esc="state.cvStats.consumed"/>
                                <div class="stat-label">Consommée</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tonnage Overview -->
            <div class="mb-4">
                <div class="section-title">
                    <i class="fa fa-balance-scale"/>Tonnage des CV actives
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-accent-primary">
                            <div class="stat-card">
                                <div class="stat-value text-primary" t-esc="formatNumber(state.cvStats.tonnage_autorise, 0)"/>
                                <div class="stat-label">Tonnage autorisé (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-accent-warning">
                            <div class="stat-card">
                                <div class="stat-value text-warning" t-esc="formatNumber(state.cvStats.tonnage_utilise, 0)"/>
                                <div class="stat-label">Tonnage utilisé (T)</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-accent-success">
                            <div class="stat-card">
                                <div class="stat-value text-success" t-esc="formatNumber(state.cvStats.tonnage_disponible, 0)"/>
                                <div class="stat-label">Tonnage disponible (T)</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Progress bar -->
                <t t-if="state.cvStats.tonnage_autorise > 0">
                    <div class="card mt-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted small">Utilisation du tonnage CV</span>
                                <span class="fw-bold">
                                    <t t-esc="formatNumber((state.cvStats.tonnage_utilise / state.cvStats.tonnage_autorise) * 100, 1)"/>%
                                </span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-warning" 
                                     t-attf-style="width: #{Math.min((state.cvStats.tonnage_utilise / state.cvStats.tonnage_autorise) * 100, 100)}%"/>
                            </div>
                        </div>
                    </div>
                </t>
            </div>

            <!-- Two columns: Recent CVs & Expiring CVs -->
            <div class="row g-4 mb-4">
                <!-- Recent CVs -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-file-text me-2"/>CV récentes</span>
                            <button class="btn btn-sm btn-light" t-on-click="() => this.openCVs()">
                                Voir toutes
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.recentCVs.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Référence</th>
                                                <th class="text-end">Disponible</th>
                                                <th>Validité</th>
                                                <th>État</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.recentCVs" t-as="cv" t-key="cv.id">
                                                <tr class="cursor-pointer" t-on-click="() => this.openCV(cv.id)">
                                                    <td>
                                                        <strong t-esc="cv.name"/>
                                                        <t t-if="cv.reference">
                                                            <br/><small class="text-muted" t-esc="cv.reference"/>
                                                        </t>
                                                    </td>
                                                    <td class="text-end text-success fw-bold">
                                                        <t t-esc="formatNumber(cv.tonnage_disponible, 2)"/> T
                                                    </td>
                                                    <td>
                                                        <small t-esc="formatDate(cv.date_validite)"/>
                                                    </td>
                                                    <td>
                                                        <span t-att-class="getStateBadgeClass(cv.state)">
                                                            <t t-esc="getStateLabel(cv.state)"/>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="p-4 text-center text-muted">
                                    <i class="fa fa-inbox fa-2x mb-2"/>
                                    <p>Aucune CV récente</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Expiring CVs -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                            <span><i class="fa fa-clock-o me-2"/>CV expirant bientôt (30 jours)</span>
                            <button class="btn btn-sm btn-light" t-on-click="openExpiringCVs">
                                Voir toutes
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <t t-if="state.expiringCVs.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Référence</th>
                                                <th class="text-end">Disponible</th>
                                                <th>Expire dans</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.expiringCVs" t-as="cv" t-key="cv.id">
                                                <tr class="cursor-pointer" t-on-click="() => this.openCV(cv.id)">
                                                    <td>
                                                        <strong t-esc="cv.name"/>
                                                    </td>
                                                    <td class="text-end">
                                                        <t t-esc="formatNumber(cv.tonnage_disponible, 2)"/> T
                                                    </td>
                                                    <td>
                                                        <t t-set="daysLeft" t-value="getDaysUntilExpiry(cv.date_validite)"/>
                                                        <span t-att-class="getExpiryBadgeClass(daysLeft)">
                                                            <t t-esc="daysLeft"/> jours
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="p-4 text-center text-muted">
                                    <i class="fa fa-check-circle fa-2x mb-2 text-success"/>
                                    <p>Aucune CV n'expire dans les 30 prochains jours</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Type Statistics -->
            <t t-if="state.productStats.length > 0">
                <div class="mb-4">
                    <div class="section-title">
                        <i class="fa fa-pie-chart"/>Répartition par type de produit
                    </div>
                    <div class="row g-3">
                        <t t-foreach="state.productStats" t-as="product" t-key="product.type">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="mb-1" t-esc="getProductTypeLabel(product.type)"/>
                                        <div class="d-flex justify-content-around mt-2">
                                            <div>
                                                <div class="stat-value text-primary" t-esc="product.count"/>
                                                <small class="text-muted">CV</small>
                                            </div>
                                            <div>
                                                <div class="stat-value text-success" t-esc="formatNumber(product.tonnage_disponible, 0)"/>
                                                <small class="text-muted">T dispo.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>
